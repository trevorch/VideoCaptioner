#!/usr/bin/env python3
"""
ASR命令行工具 - 音频文件语音识别
支持剪映和必剪两种ASR引擎
"""

import argparse
import os
import sys


# 获取当前脚本的绝对路径，并找到项目根目录
current_script_dir = os.path.dirname(os.path.abspath(__file__))  # 这是cmd目录
project_root_dir = os.path.dirname(current_script_dir)           # 这是项目根目录
#print(project_root_dir)
#app_dir = os.path.join(project_root_dir, 'app')         # 拼接出app目录的路径


# 将根目录添加到模块搜索路径
sys.path.append(project_root_dir) 

# 添加当前目录到Python路径，确保可以导入自定义模块
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    from app.core.asr import JianYingASR, BcutASR
    from app.core.asr.asr_data import ASRData
except ImportError as e:
    print(f"导入错误: {e}")
    print("请确保ASR模块可用")
    sys.exit(1)

def main():
    """主函数：处理命令行参数并执行ASR转换"""
    parser = argparse.ArgumentParser(
        description='音频文件语音识别工具',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=f'''
使用示例:
  %(prog)s /sdcard/Audio/audio.mp3
  %(prog)s /sdcard/Audio/audio.mp3 --engine jianying --format srt
  %(prog)s /sdcard/Audio/audio.mp3 -o /sdcard/Output --format both
        '''
    )
    
    # 必须参数：音频文件路径
    parser.add_argument(
        'audio_file', 
        type=str, 
        help='要处理的音频文件路径'
    )
    
    # 可选参数：输出目录
    parser.add_argument(
        '-o', '--output', 
        type=str, 
        help='输出文件目录（默认与音频文件同目录）'
    )
    
    # 可选参数：ASR引擎选择
    parser.add_argument(
        '--engine', 
        type=str, 
        choices=['jianying', 'bcut'], 
        default='bcut',
        help='选择ASR引擎：jianying（剪映）或bcut（必剪），默认为bcut'
    )
    
    # 可选参数：输出格式
    parser.add_argument(
        '--format', 
        type=str, 
        choices=['srt', 'tt', 'both'], 
        default='both',
        help='输出格式：srt、tt或both（两者都输出），默认为both'
    )
    
    # 可选参数：详细输出
    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='详细输出模式'
    )
    
    # 解析命令行参数
    args = parser.parse_args()
    
    # 检查音频文件是否存在
    if not os.path.exists(args.audio_file):
        print(f"错误：音频文件 '{args.audio_file}' 不存在")
        sys.exit(1)
    
    # 确定输出目录
    output_dir = args.output if args.output else os.path.dirname(args.audio_file)
    if output_dir == '':
        output_dir = '.'  # 如果音频文件在当前目录，输出目录设为当前目录
    
    # 确保输出目录存在
    if output_dir and not os.path.exists(output_dir):
        os.makedirs(output_dir)
        if args.verbose:
            print(f"创建输出目录: {output_dir}")
    
    # 提取文件名（不含扩展名）
    base_name = os.path.splitext(os.path.basename(args.audio_file))[0]
    
    try:
        if args.verbose:
            print(f"开始处理音频文件: {args.audio_file}")
            print(f"使用ASR引擎: {args.engine}")
            print(f"输出目录: {output_dir}")
        
        # 根据选择的引擎初始化ASR
        if args.engine == 'jianying':
            asr = JianYingASR(args.audio_file)
        else:  # bcut
            asr = BcutASR(args.audio_file)
        
        # 运行语音识别
        if args.verbose:
            print("正在执行语音识别...")
        result = asr.run()
        
        # 根据选择的格式输出文件
        output_files = []
        
        if args.format in ['srt', 'both']:
            srt_path = os.path.join(output_dir, f"{base_name}.srt")
            result.save(srt_path)
            output_files.append(srt_path)
            if args.verbose:
                print(f"SRT文件已保存至: {srt_path}")
        
        if args.format in ['tt', 'both']:
            tt_path = os.path.join(output_dir, f"{base_name}.tt")
            result.save(tt_path)
            output_files.append(tt_path)
            if args.verbose:
                print(f"TT文件已保存至: {tt_path}")
        
        # 输出成功信息
        print("语音识别处理完成！")
        print(f"生成的输出文件:")
        for file_path in output_files:
            print(f"  - {file_path}")
            
    except Exception as e:
        print(f"处理过程中发生错误：{str(e)}")
        if args.verbose:
            import traceback
            traceback.print_exc()
        sys.exit(1)

if __name__ == '__main__':
    main()
